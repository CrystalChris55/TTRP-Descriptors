
TTRPshapes = TTRPshapes or {}

TTRPshapes.exclamations = TTRPshapes.exclamations or {
    ['TTRPDescriptors.ExclamationRed'] = { r = 255, g = 0, b = 0 },
    ['TTRPDescriptors.ExclamationOrange'] = { r = 255, g = 165, b = 0 },
    ['TTRPDescriptors.ExclamationYellow'] = { r = 255, g = 255, b = 0 },
    ['TTRPDescriptors.ExclamationGreen'] = { r = 0, g = 255, b = 0 },
    ['TTRPDescriptors.ExclamationBlue'] = { r = 122, g = 122, b = 255 },
    ['TTRPDescriptors.ExclamationPink'] = { r = 255, g = 105, b = 180 },
    ['TTRPDescriptors.ExclamationPurple'] = { r = 128, g = 0, b = 128 },
    ['TTRPDescriptors.ExclamationWhite'] = { r = 255, g = 255, b = 255 },
    ['TTRPDescriptors.ExclamationGrey'] = { r = 128, g = 128, b = 128 },
    ['TTRPDescriptors.ExclamationBlack'] = { r = 0, g = 0, b = 0 },
    ['TTRPDescriptors.ExclamationRedFloating'] = { r = 255, g = 0, b = 0 },
    ['TTRPDescriptors.ExclamationOrangeFloating'] = { r = 255, g = 165, b = 0 },
    ['TTRPDescriptors.ExclamationYellowFloating'] = { r = 255, g = 255, b = 0 },
    ['TTRPDescriptors.ExclamationGreenFloating'] = { r = 0, g = 255, b = 0 },
    ['TTRPDescriptors.ExclamationBlueFloating'] = { r = 122, g = 122, b = 255 },
    ['TTRPDescriptors.ExclamationPinkFloating'] = { r = 255, g = 105, b = 180 },
    ['TTRPDescriptors.ExclamationPurpleFloating'] = { r = 128, g = 0, b = 128 },
    ['TTRPDescriptors.ExclamationWhiteFloating'] = { r = 255, g = 255, b = 255 },
    ['TTRPDescriptors.ExclamationGreyFloating'] = { r = 128, g = 128, b = 128 },
    ['TTRPDescriptors.ExclamationBlackFloating'] = { r = 0, g = 0, b = 0 },
}

TTRPshapes.questions = TTRPshapes.questions or {
    ['TTRPDescriptors.QuestionRed'] = { r = 255, g = 0, b = 0 },
    ['TTRPDescriptors.QuestionOrange'] = { r = 255, g = 165, b = 0 },
    ['TTRPDescriptors.QuestionYellow'] = { r = 255, g = 255, b = 0 },
    ['TTRPDescriptors.QuestionGreen'] = { r = 0, g = 255, b = 0 },
    ['TTRPDescriptors.QuestionBlue'] = { r = 122, g = 122, b = 255 },
    ['TTRPDescriptors.QuestionPink'] = { r = 255, g = 105, b = 180 },
    ['TTRPDescriptors.QuestionPurple'] = { r = 128, g = 0, b = 128 },
    ['TTRPDescriptors.QuestionWhite'] = { r = 255, g = 255, b = 255 },
    ['TTRPDescriptors.QuestionGrey'] = { r = 128, g = 128, b = 128 },
    ['TTRPDescriptors.QuestionBlack'] = { r = 0, g = 0, b = 0 },
    ['TTRPDescriptors.QuestionRedFloating'] = { r = 255, g = 0, b = 0 },
    ['TTRPDescriptors.QuestionOrangeFloating'] = { r = 255, g = 165, b = 0 },
    ['TTRPDescriptors.QuestionYellowFloating'] = { r = 255, g = 255, b = 0 },
    ['TTRPDescriptors.QuestionGreenFloating'] = { r = 0, g = 255, b = 0 },
    ['TTRPDescriptors.QuestionBlueFloating'] = { r = 122, g = 122, b = 255 },
    ['TTRPDescriptors.QuestionPinkFloating'] = { r = 255, g = 105, b = 180 },
    ['TTRPDescriptors.QuestionPurpleFloating'] = { r = 128, g = 0, b = 128 },
    ['TTRPDescriptors.QuestionWhiteFloating'] = { r = 255, g = 255, b = 255 },
    ['TTRPDescriptors.QuestionGreyFloating'] = { r = 128, g = 128, b = 128 },
    ['TTRPDescriptors.QuestionBlackFloating'] = { r = 0, g = 0, b = 0 },
}

TTRPshapes.shapes = TTRPshapes.shapes or {
    ['TTRPDescriptors.XRed'] = { r = 255, g = 0, b = 0 },
    ['TTRPDescriptors.XOrange'] = { r = 255, g = 165, b = 0 },
    ['TTRPDescriptors.XYellow'] = { r = 255, g = 255, b = 0 },
    ['TTRPDescriptors.XGreen'] = { r = 0, g = 255, b = 0 },
    ['TTRPDescriptors.XBlue'] = { r = 122, g = 122, b = 255 },
    ['TTRPDescriptors.XPink'] = { r = 255, g = 105, b = 180 },
    ['TTRPDescriptors.XPurple'] = { r = 128, g = 0, b = 128 },
    ['TTRPDescriptors.XWhite'] = { r = 255, g = 255, b = 255 },
    ['TTRPDescriptors.XGrey'] = { r = 128, g = 128, b = 128 },
    ['TTRPDescriptors.XBlack'] = { r = 0, g = 0, b = 0 },
    ['TTRPDescriptors.XRedFloating'] = { r = 255, g = 0, b = 0 },
    ['TTRPDescriptors.XOrangeFloating'] = { r = 255, g = 165, b = 0 },
    ['TTRPDescriptors.XYellowFloating'] = { r = 255, g = 255, b = 0 },
    ['TTRPDescriptors.XGreenFloating'] = { r = 0, g = 255, b = 0 },
    ['TTRPDescriptors.XBlueFloating'] = { r = 122, g = 122, b = 255 },
    ['TTRPDescriptors.XPinkFloating'] = { r = 255, g = 105, b = 180 },
    ['TTRPDescriptors.XPurpleFloating'] = { r = 128, g = 0, b = 128 },
    ['TTRPDescriptors.XWhiteFloating'] = { r = 255, g = 255, b = 255 },
    ['TTRPDescriptors.XGreyFloating'] = { r = 128, g = 128, b = 128 },
    ['TTRPDescriptors.XBlackFloating'] = { r = 0, g = 0, b = 0 },
    ['TTRPDescriptors.ORed'] = { r = 255, g = 0, b = 0 },
    ['TTRPDescriptors.OOrange'] = { r = 255, g = 165, b = 0 },
    ['TTRPDescriptors.OYellow'] = { r = 255, g = 255, b = 0 },
    ['TTRPDescriptors.OGreen'] = { r = 0, g = 255, b = 0 },
    ['TTRPDescriptors.OBlue'] = { r = 122, g = 122, b = 255 },
    ['TTRPDescriptors.OPink'] = { r = 255, g = 105, b = 180 },
    ['TTRPDescriptors.OPurple'] = { r = 128, g = 0, b = 128 },
    ['TTRPDescriptors.OWhite'] = { r = 255, g = 255, b = 255 },
    ['TTRPDescriptors.OGrey'] = { r = 128, g = 128, b = 128 },
    ['TTRPDescriptors.OBlack'] = { r = 0, g = 0, b = 0 },
    ['TTRPDescriptors.ORedFloating'] = { r = 255, g = 0, b = 0 },
    ['TTRPDescriptors.OOrangeFloating'] = { r = 255, g = 165, b = 0 },
    ['TTRPDescriptors.OYellowFloating'] = { r = 255, g = 255, b = 0 },
    ['TTRPDescriptors.OGreenFloating'] = { r = 0, g = 255, b = 0 },
    ['TTRPDescriptors.OBlueFloating'] = { r = 122, g = 122, b = 255 },
    ['TTRPDescriptors.OPinkFloating'] = { r = 255, g = 105, b = 180 },
    ['TTRPDescriptors.OPurpleFloating'] = { r = 128, g = 0, b = 128 },
    ['TTRPDescriptors.OWhiteFloating'] = { r = 255, g = 255, b = 255 },
    ['TTRPDescriptors.OGreyFloating'] = { r = 128, g = 128, b = 128 },
    ['TTRPDescriptors.OBlackFloating'] = { r = 0, g = 0, b = 0 },
}

    TTRPshapes.pinnednotes = TTRPshapes.pinnednotes or {
    ['TTRPDescriptors.PinnedPaper']= { r = 128, g = 128, b = 128 },
    ['TTRPDescriptors.PinnedPaperKnife']= { r = 128, g = 128, b = 128 },
    ['TTRPDescriptors.PinnedPaperKnife2']= { r = 128, g = 128, b = 128 },
    ['TTRPDescriptors.PinnedPaperScrewdriver']= { r = 128, g = 128, b = 128 },
}

    TTRPshapes.propscenes = TTRPshapes.propscenes or {
    ['TTRPDescriptors.MetalSignpost']= { r = 128, g = 128, b = 128 },
    ['TTRPDescriptors.MetalSignpostBloody']= { r = 128, g = 128, b = 128 },
    ['TTRPDescriptors.MetalSignpostAlert']= { r = 128, g = 128, b = 128 },
    ['TTRPDescriptors.MetalSignpostHeal']= { r = 128, g = 128, b = 128 },
    ['TTRPDescriptors.MetalSignpostOvergrown']= { r = 128, g = 128, b = 128 },
    ['TTRPDescriptors.WoodenSignpost']= { r = 137, g = 34, b = 1 },
    ['TTRPDescriptors.WoodenSignpostOvergrown']= { r = 137, g = 34, b = 1 },
    ['TTRPDescriptors.WoodenSignpostBloody']= { r = 137, g = 34, b = 1 },
    ['TTRPDescriptors.FloatingWoodSignAlert']= { r = 137, g = 34, b = 1 },
    ['TTRPDescriptors.FloatingWoodSignOvergrown']= { r = 137, g = 34, b = 1 },
    ['TTRPDescriptors.FloatingWoodSignHeal']= { r = 137, g = 34, b = 1 },
    ['TTRPDescriptors.FloatingWoodSign']= { r = 137, g = 34, b = 1 },
    ['TTRPDescriptors.BloodPuddle']= { r = 255, g = 1, b = 1 },
}

    TTRPshapes.notadmin = TTRPshapes.notadmin or {
    ['TTRPDescriptors.XBlue'] = { r = 122, g = 122, b = 255 },
    ['TTRPDescriptors.QuestionBlue'] = { r = 122, g = 122, b = 255 },
    ['TTRPDescriptors.ExclamationBlue'] = { r = 122, g = 122, b = 255 },
    ['TTRPDescriptors.XBlueFloating'] = { r = 122, g = 122, b = 255 },
    ['TTRPDescriptors.QuestionBlueFloating'] = { r = 122, g = 122, b = 255 },
    ['TTRPDescriptors.ExclamationBlueFloating'] = { r = 122, g = 122, b = 255 },
    ['TTRPDescriptors.OBlue'] = { r = 122, g = 122, b = 255 },
    ['TTRPDescriptors.OBlueFloating'] = { r = 122, g = 122, b = 255 },
}

function OnWorldRightClick_OpenInvestigationUI(playerIndex, context, worldObjects)
    local player = getSpecificPlayer(playerIndex)
    local isAdmin = isAdmin()
    if not player or not player:isAlive() then return end
    
    if isAdmin or SandboxVars.TTRPDescriptors.ToggleUI then
        local uiOption = context:addOption(getText("ContextMenu_TTRPDescriptors_OpenInvestigationUI"), player, function()
            OpenInvestigationUI()
        end)
        uiOption.iconTexture = getTexture("media/ui/Search_Icon_Off.png")
    end
end    

function OnFillWorldObjectContextMenu(playerIndex, context, worldObjects, test)
    local player = getSpecificPlayer(playerIndex)
    local isAdmin = isAdmin()

    for i,v in ipairs(worldObjects) do
        if instanceof(v, "IsoWorldInventoryObject") and (TTRPshapes.exclamations[v:getItem():getFullType()] or TTRPshapes.questions[v:getItem():getFullType()]) then
            local readOption = context:addOptionOnTop(getText("ContextMenu_TTRPDescriptors_InvestigateScene"), v:getItem(), ISInventoryPaneContextMenu.onWriteSomething, false, playerIndex)
            readOption.iconTexture = getTexture("media/ui/Search_Icon_Off.png")
        end
    end
end

function CreateScenesSubMenu(playerIndex, context, worldObjects, test, title, items, topLevelItemName)
    local createOption = context:addOption(title, worldobjects, nil);
    local topLevelItem = getScriptManager():FindItem(topLevelItemName)
    createOption.iconTexture = topLevelItem and topLevelItem:getNormalTexture() or nil
    local exclamationSubMenu = context:getNew(context);
    context:addSubMenu(createOption, exclamationSubMenu);

    for k,v in pairs(items) do
        local scriptItem = getScriptManager():FindItem(k)
        local name = scriptItem and scriptItem:getDisplayName() or k
        local option = exclamationSubMenu:addOption(name, worldobjects, onCreateScene, true, playerIndex, k);
        option.iconTexture = scriptItem and scriptItem:getNormalTexture() or nil
    end
end

function OnFillInventoryObjectContextMenu(player, context, items)
    local testItem = nil
    local sceneItem = nil
    for i,v in ipairs(items) do
        if not instanceof(v, "InventoryItem") then
            testItem = v.items[1]
        else 
            testItem = v
        end
        if TTRPshapes.exclamations[testItem:getFullType()] or TTRPshapes.questions[testItem:getFullType()] then
            sceneItem = testItem
            break
        end
    end
    if sceneItem then
        local sceneOptionsSubMenu = context:getNew(context)

        if sceneItem:getWorldItem() ~= nil then
            context:removeOptionByName(getText("ContextMenu_TTRPDescriptors_Grab"))
            context:removeOptionByName(getText("ContextMenu_TTRPDescriptors_Equip_Primary"))
            context:removeOptionByName(getText("ContextMenu_TTRPDescriptors_Equip_Secondary"))
            local placeOption = context:getOptionFromName(getText("ContextMenu_TTRPDescriptors_PlaceItemOnGround"))
            if placeOption then
                placeOption.name = getText("ContextMenu_MoveScene")
            end

            sceneOptionsSubMenu:addOption(getText("ContextMenu_TTRPDescriptors_PickupSceneForEdit"), {sceneItem}, ISInventoryPaneContextMenu.onGrabItems, player)
        else
            local placeOption = context:getOptionFromName(getText("ContextMenu_TTRPDescriptors_PlaceItemOnGround"))
            if placeOption then
                placeOption.name = getText("ContextMenu_TTRPDescriptors_PlaceScene")
            end

            sceneOptionsSubMenu:addOption(getText("ContextMenu_TTRPDescriptors_EditScene"), sceneItem, onEditScene, true, player)
        end

        local readOption = nil
        for _,option in ipairs(context.options) do
            if option.onSelect == ISInventoryPaneContextMenu.onWriteSomething then
                readOption = option
                break
            end
        end
        if readOption then
            readOption.name = getText("ContextMenu_TTRPDescriptors_InvestigateScene")
            readOption.iconTexture = getTexture("media/ui/Search_Icon_Off.png");
        end

        local sceneOptions = context:addOption(getText("ContextMenu_TTRPDescriptors_SceneOptions"), sceneItem, nil)
        context:addSubMenu(sceneOptions, sceneOptionsSubMenu)
        
        sceneOptionsSubMenu:addOption(getText("ContextMenu_TTRPDescriptors_DeleteScene"), sceneItem, onDeleteScene, player)
    end
end

function onCreateScene(editable, playerIndex, itemType)
    local playerObj = getSpecificPlayer(playerIndex)
    local item = playerObj:getInventory():AddItem(itemType)
    local fontHgt = getTextManager():getFontFromEnum(UIFont.Small):getLineHeight()
    local height = 110 + (15 * fontHgt)
    
    local modal = DescriptorCreateModal:new(0, 0, 350, height, nil, onCreateSceneClick, playerObj, item, item:seePage(1), item:getName(), 15, editable, item:getPageToWrite())
    modal:initialise()
    modal:addToUIManager()
    
    if JoypadState.players[playerIndex+1] then
        setJoypadFocus(playerIndex, modal)
    end
end

function onEditScene(item, editable, player)
    local playerObj = getSpecificPlayer(player)
    local fontHgt = getTextManager():getFontFromEnum(UIFont.Small):getLineHeight()
    local height = 110 + (15 * fontHgt);
    local modal = DescriptorCreateModal:new(0, 0, 350, height, nil, onCreateSceneClick, playerObj, item, item:seePage(1), item:getName(), 15, editable, item:getPageToWrite());
    modal:initialise();
    modal:addToUIManager();
    if JoypadState.players[player+1] then
        setJoypadFocus(player, modal)
    end
end

function onCreateSceneClick(button)
    if button.internal == "OK" then
        for i,v in ipairs(button.parent.newPage) do
            button.parent.notebook:addPage(i,v);
        end
        local title = button.parent.title:getText()
        button.parent.notebook:setName(title);
        button.parent.notebook:setCustomName(true);

        local player = getSpecificPlayer(button.parent.playerNum)
        local x = player:getX()
        local y = player:getY()
        local z = player:getZ()
        ISLogSystem.sendLog(player, "tracking", "[" .. player:getUsername() .. "][" .. player:getDescriptor():getForename() .. "][".. player:getDescriptor():getSurname() .."][CreateScene][" .. x .. "," .. y .. "," .. z .. "] " .. title .. "," .. tostring(button.parent.notebook:seePage(1)))

        ISInventoryPaneContextMenu.onPlaceItemOnGround({button.parent.notebook}, player)
    end
end

function onDeleteScene(item, player)
    local width = 350;
    local x = getPlayerScreenLeft(player) + (getPlayerScreenWidth(player) - width) / 2
    local height = 120;
    local y = getPlayerScreenTop(player) + (getPlayerScreenHeight(player) - height) / 2
    local modal = ISModalDialog:new(x,y, width, height, getText("IGUI_TTRPDescriptors_DeleteScene"), true, item, onDeleteSceneConfirm, player);
    modal:initialise()
    modal:addToUIManager()
    if JoypadState.players[player+1] then
        modal.prevFocus = JoypadState.players[player+1].focus
        setJoypadFocus(player, modal)
    end
end

function onDeleteSceneConfirm(target, button)
    if button.internal == "YES" then
        local player = getSpecificPlayer(button.player)
        local x = player:getX()
        local y = player:getY()
        local z = player:getZ()
        ISLogSystem.sendLog(player, "tracking", "[" .. player:getUsername() .. "][" .. player:getDescriptor():getForename() .. "][".. player:getDescriptor():getSurname() .."][DeleteScene][" .. x .. "," .. y .. "," .. z .. "] " .. target:getName())
        ISRemoveItemTool.removeItem(target, button.player)
    end
end


function OnPlayerUpdate(player)
    if not player:isLocalPlayer() then
        return
    end

    local x = math.floor(player:getX())
    local y = math.floor(player:getY())
    local z = math.floor(player:getZ())
    local range = 2
    for xo=-range, range do
        for yo=-range, range do
            local square = getSquare(x + xo, y + yo, z)
            if square then
                local worldObjects = square:getWorldObjects()
                for i=0,worldObjects:size()-1 do
                    local object = worldObjects:get(i)
                    local item = object:getItem()
                    local sceneItemType = TTRPshapes.exclamations[item:getFullType()] or TTRPshapes.questions[item:getFullType()] or TTRPshapes.shapes[item:getFullType()] or TTRPshapes.pinnednotes[item:getFullType()] or TTRPshapes.propscenes[item:getFullType()]
                    if sceneItemType then
                        local objectModData = object:getModData()
                        local nowms = getTimestampMs()
                        local lastSceneHaloMs = objectModData.lastSceneHaloMs or 0
                        if nowms - lastSceneHaloMs > 50 then
                            if player:isFacingObject(object, 0.8) then
                                player:setHaloNote("[img=Question_On]  " .. item:getName(), sceneItemType.r, sceneItemType.g, sceneItemType.b, 50)
                                objectModData.lastSceneHaloMs = nowms
                            end
                        end
                    end
                end
            end
        end
    end
end

TTRPshapes.onCreateScene = onCreateScene
Events.OnFillWorldObjectContextMenu.Add(OnFillWorldObjectContextMenu)
Events.OnFillWorldObjectContextMenu.Add(OnWorldRightClick_OpenInvestigationUI)
Events.OnFillInventoryObjectContextMenu.Add(OnFillInventoryObjectContextMenu)
Events.OnPlayerUpdate.Add(OnPlayerUpdate)
